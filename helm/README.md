# FLUENT BIT

## TL;DR

```console
helm plugin install https://github.com/hypnoglow/helm-s3.git --version v0.8.0
helm repo add lms-helm-charts s3://lms-helm-charts/
helm install lms-helm-charts/fluent-bit --version x.x.x
```

## Introduction

This chart bootstraps a fluent-bit [FluentBit](https://fluentbit.io/) daemonset on a [Kubernetes](https://kubernetes.io) cluster.  

## Prerequisites Details

* Kubernetes secret of type docker-registry created in order to access the specified docker registry

## Chart Details

 This chart is based on a custom Docker image derived from the official [Fluent Bit Repo](https://github.com/fluent/fluent-bit).

Six Kubernetes objects are defined in the chart:

* 1 ServiceAccount
* 1 ClusterRole
* 1 ClusterRoleBinding
* 1 ConfigMap
* 1 Daemonset
* 6 Secrets

### ServiceAccount Object

The [Kubernetes ServiceAccount](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/) provides an identity for processes that run in the Pods created by the Daemonset.

### ClusterRole Object

The [Kubernetes ClusterRole](https://kubernetes.io/docs/admin/authorization/rbac/#role-and-clusterrole) defines a set of permissions to interact with the Kubernetes API.

### ClusterRoleBinding Object

The [Kubernetes ClusterRoleBinding](https://kubernetes.io/docs/admin/authorization/rbac/#rolebinding-and-clusterrolebinding) associates the ClusterRole with the ServiceAccout.

### ConfigMap Object

The [Kubernetes ConfigMap](https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/) is used to specify the FluentBit configuration.

### Daemonset Object

The [Kubernetes Daemonset](https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/) defines the [Kubernetes Pod](https://kubernetes.io/docs/concepts/workloads/pods/pod/) specifications and how they will be managed. The daemonset ensures that all nodes run a copy of the pod.

### Pod Security Policy Object

The [Kubernetes Pod Security Policy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/) defines security sensitive aspects of the pod specification.

### Secret Objects

There are up to six [Kubernetes Secrets](https://kubernetes.io/docs/concepts/configuration/secret/) defined in the chart.

* es-ca-secret: CA Certificate of the Elasticsearch backend (TLS proxy)
* es-tls-secret: TLS Certificates to authenticate to the Elasticsearch backend (TLS proxy)
* forward-ca-secret: CA Certificate of the Forward backend (TLS proxy))
* forward-tls-secret: TLS Certificates to authenticate to the Forward backend (TLS proxy)
* pg-ca-secret: CA Certificate of the Prometheus Pushgateway
* pg-tls-secret: TLS Certificates to authenticate to the Prometheus Pushgateway

### ServiceMonitor Object

The [ServiceMonitor](https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#servicemonitor) defines monitoring for a set of services. It allows the metrics endpoint of Fluent Bit to be scraped by Prometheus.

### Service Object

The [Kubernetes Service](https://kubernetes.io/docs/concepts/services-networking/service/) defines the service of the metrics endpoint of Fluent Bit.

## Installing the Chart

To install the chart with the release name `my-release`:

### Installing with Helm and Tiller

```console
helm install --name my-release lms-helm-charts/fluent-bit --version x.x.x
```

### Installing with generated Kubernetes manifests

```console
helm fetch lms-helm-charts/fluent-bit --version x.x.x
helm template fluent-bit-x.x.x.tgz -n my-release --output-dir .
kubectl apply -f fluent-bit/templates/
```

## Uninstalling the Chart

### Uninstalling with Helm and Tiller

To uninstall/delete the `my-release` deployment:

```console
helm delete my-release
```

### Uninstalling with generated Kubernetes manifests

```console
kubectl delete -f fluent-bit/templates/
```

## Configuration

The following table lists the configurable parameters of the elasticsearch-single-node chart and their default values.

| Parameter                                     | Description                                                                                                                                                                                                                                                                                                                                                     | Default                                                                            |
| --------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------- |
| `enabled`                                     | Install or not this chart                                                                                                                                                                                                                                                                                                                                       | `true`                                                                             |
| `global.imageRepository`                      | Repository to use for all images. If specified, all images repository values will be overriden by this.                                                                                                                                                                                                                                                         | `''`                                                                               |
| `global.inMasterChart`                        | Whether or not the chart is part of a master chart (Used for tests)                                                                                                                                                                                                                                                                                             | `false`                                                                            |
| `defaultLabels`                               | The labels to apply on all resources. If not specified, the "app" label is applied. If specified, these labels are applied in place of the default "app" label.                                                                                                                                                                                                 | `{}`                                                                               |
| `helmLabels`                                  | Whether to apply labels specific to Helm: chart, release, heritage.                                                                                                                                                                                                                                                                                             | `true`                                                                             |
| `extraLabels`                                 | Any other labels that need to be applied on top of the default and Helm labels.                                                                                                                                                                                                                                                                                 | `{}`                                                                               |
| `image.fluent_bit.repository`                 | Path to the Fluent Bit Docker image on a specific Docker registry.                                                                                                                                                                                                                                                                                              | `us.gcr.io/sap-se-hyb-idefix-operations/lms/fluent-bit`                            |
| `image.fluent_bit.tag`                        | Version of the Fluent Bit Docker image.                                                                                                                                                                                                                                                                                                                         | `1.2.1`                                                                            |
| `image.fluent_bit.pullPolicy`                 | imagePullPolicy for the Fluent Bit container: 'IfNotPresent' or 'Always'.                                                                                                                                                                                                                                                                                       | `IfNotPresent`                                                                     |
| `image.fluent_bit.repository`                 | Path to the Metrics Collector Docker image on a specific Docker registry.                                                                                                                                                                                                                                                                                       | `us.gcr.io/sap-se-hyb-idefix-operations/lms/metrics-collector`                     |
| `image.fluent_bit.tag`                        | Version of the Metrics Collector Docker image.                                                                                                                                                                                                                                                                                                                  | `3.10.1`                                                                           |
| `image.fluent_bit.pullPolicy`                 | imagePullPolicy for the Metrics Collector container: 'IfNotPresent' or 'Always'.                                                                                                                                                                                                                                                                                | `IfNotPresent`                                                                     |
| `imagePullSecrets`                            | Name of the secret to access the Docker registry, the secret must already exist.                                                                                                                                                                                                                                                                                | `lms-gcr-registry`                                                                 |
| `env`                                         | Environment variables passed to the daemonset                                                                                                                                                                                                                                                                                                                   |                                                                                    |
| `updateStrategy.type`                         | the type of strategy the update to undertake                                                                                                                                                                                                                                                                                                                    | `RollingUpdate`                                                                    |
| `updateStrategy.rollingUpdate.maxUnavailable` | if rolling update was the strategy undertaken, this ensures at most this number of pods are unavailable at all times                                                                                                                                                                                                                                            | `0`                                                                                |
| `conf.Service.Log_Level`                      | Decides the logging verbosity level. Allowed values are error, info, debug, trace. The level increases from left to right and is accumulative, if 'debug' is set, it includes error, info, and debug. `trace` is only available if Fluent Bit is built with WITH_TRACE enabled                                                                                  | `info`                                                                             |
| `conf.Service.HTTP_Server`                    | Enable built-in HTTP Server                                                                                                                                                                                                                                                                                                                                     | `on`                                                                               |
| `conf.Service.HTTP_Listen`                    | Set listening interface for HTTP Server when it's enabled                                                                                                                                                                                                                                                                                                       | `0.0.0.0`                                                                          |
| `conf.Service.HTTP_Port`                      | Set TCP Port for the HTTP Server                                                                                                                                                                                                                                                                                                                                | `2020`                                                                             |
| `conf.Input.Kubernetes.Path`                  | Using the Fluent Bit [Tail Plugin](https://fluentbit.io/documentation/current/input/tail.html), this specific the pattern for log files or multiple log files                                                                                                                                                                                                   | `/var/log/containers/*.log`                                                        |
| `conf.Input.Kubernetes.Exclude_Path`          | Set shell patterns separated by commas to exclude filese matching the criteria. e.g. exclude_path: *.gz,*.zip                                                                                                                                                                                                                                                   |                                                                                    |
| `conf.Input.Kubernetes.Parser`                | Specify the name of a parser to interpret the entry as a structured message.                                                                                                                                                                                                                                                                                    | `docker`                                                                           |
| `conf.Input.Kubernetes.Docker_Mode`           | If enabled, the plugin will recombine split Docker log lines before passing them to any parser as configured above.                                                                                                                                                                                                                                             | `On`                                                                               |
| `conf.Input.Kubernetes.Docker_Mode_Flush`     | Wait period time in seconds to flush queued unfinished split lines.                                                                                                                                                                                                                                                                                             | `4`                                                                                |
| `conf.Input.Kubernetes.Mem_Buf_Limit`         | Set the limit of memory that the tail plugin can use when appending data to the endinge. The plugin is paused with the limit is reached and resumes when data is flushed                                                                                                                                                                                        | 20MB                                                                               |
| `conf.Input.Kubernetes.Skip_Long_Lines`       | When the monitored file reaches buffer capacity due to long line, it stops monitoring the file by default. This instructs Fluent Bit to skip that line and continue processing the file                                                                                                                                                                         | `On`                                                                               |
| `conf.Input.Kubernetes.Refresh_Interval`      | The interval for refreshing list of watched files                                                                                                                                                                                                                                                                                                               | `5`                                                                                |
| `conf.Input.Kubernetes.Buffer_Chunk_Size`     | Set initial buffer size to read file data. Used too to increase buffer size.                                                                                                                                                                                                                                                                                    |                                                                                    |
| `conf.Input.Kubernetes.Buffer_Max_Size`       | Set limit of buffer size per monitored file. When buffer needs to increase, this sets an upper ceiling If file exceeds the limit the file is removed from the monitored file list                                                                                                                                                                               |                                                                                    |
| `conf.Input.Systemd.enabled`                  | Whether or not to enabled systemd input plugin                                                                                                                                                                                                                                                                                                                  | `false`                                                                            |
| `conf.Input.Systemd.path`                     | Path on the host to collect systemd logs                                                                                                                                                                                                                                                                                                                        | `/var/log/journal`                                                                 |
| `conf.Output.Elasticsearch.enabled`           | Decide if the output will be flushed to Elasticsearch                                                                                                                                                                                                                                                                                                           |                                                                                    |
| `conf.Output.Elasticsearch.Match`             | Pattern for the data that will be output                                                                                                                                                                                                                                                                                                                        | `*`                                                                                |
| `conf.Output.Elasticsearch.Generate_ID`       | When enabled, generated _id for outgoing records. This prevents duplicate records when retrying ES                                                                                                                                                                                                                                                              | `On`                                                                               |
| `conf.Output.Elasticsearch.Replace_Dots`      | When enabled, replace field name dots with underscore, required by Elasticsearch 2.0-2.3.                                                                                                                                                                                                                                                                       | `On`                                                                              |
| `conf.Output.Elasticsearch.Buffer_Size`       | Specify the buffer size to read the response from Elasticsearch HTTP service. To set unlimited amount, set value to False                                                                                                                                                                                                                                       | `false`                                                                            |
| `conf.Output.Elasticsearch.Time_Key`          | Search record will get a new timestamp field. The Time_key property defines the name of that field                                                                                                                                                                                                                                                              |                                                                                    |
| `conf.Output.forward.enabled`                 | Decide if the output will be flushed to the Log-Forwarder                                                                                                                                                                                                                                                                                                       |                                                                                    |
| `conf.Output.forward.Match`                   | Pattern for the data that will be output                                                                                                                                                                                                                                                                                                                        | `*`                                                                                |
| `conf.Output.stdout.enabled`                  | Decide if the output will be flushed to the standard output                                                                                                                                                                                                                                                                                                     |                                                                                    |
| `conf.Output.stdout.Match`                    | Pattern for the data that will be output                                                                                                                                                                                                                                                                                                                        | `*`                                                                                |
| `conf.Filter.Kubernetes.Merge_Log`            | When enabled, it checks if the log field content is a JSON string map, if so, it append the map fields as part of the log structure.                                                                                                                                                                                                                            | `On`                                                                               |
| `conf.Filter.Kubernetes.Merge_Log_Key`        | When Merge_Log is enabled, the filter tries to assume the log field from the incoming message is a JSON string message and make a structured representation of it at the same level of the log field in the map. Now if Merge_Log_Key is set (a string name), all the new structured fields taken from the original log content are inserted under the new key. | `logs`                                                                             |
| `conf.Parsers`                                | The Fluent Bit parsers configuration file in its entirety, additional parsers can be added by appending to existing parsers                                                                                                                                                                                                                                     | As is                                                                              |
| `backend.es.host`                             | IP address or hostname of the target Elasticsearch instance                                                                                                                                                                                                                                                                                                     | `elasticsearch`                                                                    |
| `backend.es.port`                             | TCP port of the target Elasticsearch instance                                                                                                                                                                                                                                                                                                                   | `9200`                                                                             |
| `backend.es.type`                             | Type name                                                                                                                                                                                                                                                                                                                                                       | `flb_type`                                                                         |
| `backend.es.logstash_prefix`                  | When Logstash_Format is enabled, the Index name is composed using a prefix and the date, e.g: If Logstash_Prefix is equals to 'mydata' your index will become 'mydata-YYYY.MM.DD'. The last string appended belongs to the date when the data is being generated.                                                                                               | `flb`                                                                              |
| `backend.es.http_user`                        | Optional username credential for Elastic X-Pack access                                                                                                                                                                                                                                                                                                          |                                                                                    |
| `backend.es.http_passwd`                      | Password for user defined in HTTP_User                                                                                                                                                                                                                                                                                                                          |                                                                                    |
| `backend.es.tls`                              | Optional TLS encryption to ElasticSearch instance                                                                                                                                                                                                                                                                                                               | `"off"`                                                                            |
| `backend.es.tls_verify`                       | Enable to force certificate validation for TLS                                                                                                                                                                                                                                                                                                                  | `on`                                                                               |
| `backend.es.tls_ca`                           | TLS CA certificate for the Elasticsearch backend (in base64 PEM format). Use if tls=on and tls_verify=on.                                                                                                                                                                                                                                                       |                                                                                    |
| `backend.es.tls_crt`                          | TLS certificate to authenticate to the Elasticsearch backend (in base64 PEM format). Use if tls=on and tls_verify=on.                                                                                                                                                                                                                                           |                                                                                    |
| `backend.es.tls_key`                          | TLS key to authenticate to the Elasticsearch backend (in base64 PEM format). Use if tls=on and tls_verify=on.                                                                                                                                                                                                                                                   |                                                                                    |
| `backend.es.key_passwd`                       | Optional password for tls.key_file file                                                                                                                                                                                                                                                                                                                         |                                                                                    |
| `backend.es.tls_debug`                        | Set TLS debug verbosity level. It accept the following values: 0 (No debug), 1 (Error), 2 (State change), 3 (Informational) and 4 Verbose                                                                                                                                                                                                                       | `1`                                                                                |
| `backend.forward.host`                        | IP address or hostname of the target log-forwarder instance                                                                                                                                                                                                                                                                                                     | `log-forwarder`                                                                    |
| `backend.forward.port`                        | TCP port of the target log-forwarder instance                                                                                                                                                                                                                                                                                                                   | `24224`                                                                            |
| `backend.forward.tls.enabled`                 | Optional TLS encryption to log-forwarder instance                                                                                                                                                                                                                                                                                                               | `false`                                                                            |
| `backend.forwaed.tls.verify`                  | Enable to force certificate validation for TLS                                                                                                                                                                                                                                                                                                                  | `on`                                                                               |
| `backend.forward.tls.ca`                      | TLS CA certificate for the log-forwarder (in base64 PEM format). Use if tls=on and tls_verify=on.                                                                                                                                                                                                                                                               |                                                                                    |
| `backend.forward.tls.cert`                    | TLS certificate for the log-forwarder (in base64 PEM format). Use if tls=on and tls_verify=on.                                                                                                                                                                                                                                                                  |                                                                                    |
| `backend.forward.tls.key`                     | TLS key for the log-forwarder (in base64 PEM format). Use if tls=on and tls_verify=on.                                                                                                                                                                                                                                                                          |                                                                                    |
| `backend.forward.tls.debug`                   | Set TLS debug verbosity level. It accept the following values: 0 (No debug), 1 (Error), 2 (State change), 3 (Informational) and 4 Verbose                                                                                                                                                                                                                       | `1`                                                                                |
| `serviceMonitor.enabled`                      | if `true`, creates a Prometheus Operator ServiceMonitor                                                                                                                                                                                                                                                                                                         | `false`                                                                            |
| `serviceMonitor.interval`                     | How frequently to scrape metrics (if not used, falling back to Prometheus default)                                                                                                                                                                                                                                                                              | `nil`                                                                              |
| `serviceMonitor.selector`                     | Default to kube-prometheus install (CoreOS recommended), but should be set according to Prometheus install                                                                                                                                                                                                                                                      | `{ prometheus: prometheus-operator, serviceMonitorSelector: prometheus-operator }` |
| `prometheusPushGateway.enabled`               | Determines whether or not Prometheus pushgateway script will be enabled as a sidecar                                                                                                                                                                                                                                                                            | `false`                                                                            |
| `prometheusPushGateway.schedule`              | Determines Schedule to run the collection script                                                                                                                                                                                                                                                                                                                | `* * * * *`                                                                        |
| `prometheusPushGateway.endpoint`              | Specifies PushGateway endpoint URL                                                                                                                                                                                                                                                                                                                              | `''` (Required)                                                                    |
| `prometheusPushGateway.metricsEndpoint`       | Specifies the metrics endpoint to be collected                                                                                                                                                                                                                                                                                                                  | `http://localhost:2020/api/v1/metrics/prometheus`                                  |
| `prometheusPushGateway.tls.enabled`           | Optional TLS encryption to PushGateway instance                                                                                                                                                                                                                                                                                                                 | `false`                                                                            |
| `prometheusPushGateway.tls.auth`              | Enable / Disable client authentication for PushGateway                                                                                                                                                                                                                                                                                                          | `false`                                                                            |
| `prometheusPushGateway.tls.verify`            | Enabled / Disable the verification of the CA Certificate                                                                                                                                                                                                                                                                                                        | `false`                                                                            |
| `prometheusPushGateway.tls.caCertificate`     | TLS CA certificate for the PushGateway (in base64 PEM format). Use if tls.enabled=true and tls.verify=true.                                                                                                                                                                                                                                                     | `''`                                                                               |
| `prometheusPushGateway.tls.cert`              | TLS certificate for the PushGateway (in base64 PEM format). Use if tls.enabled=true and tls.verify=true.                                                                                                                                                                                                                                                        | `''`                                                                               |
| `prometheusPushGateway.tls.key`               | TLS key for the PushGateway (in base64 PEM format). Use if tls.enabled=true and tls.verify=true.                                                                                                                                                                                                                                                                | ``                                                                                 |
| `rbac.create`                                 | Decides if the RBAC resources `cluster-role` and `cluster-rolebinding` will be created                                                                                                                                                                                                                                                                          | `true`                                                                             |
| `serviceAccount.create`                       | Decides if the `ServiceAccount` resource is to be created                                                                                                                                                                                                                                                                                                       | `true`                                                                             |
| `serviceAccount.name`                         | The name of the `ServiceAccount` to generate, if not set and create is true, a name is generated using the fullname template                                                                                                                                                                                                                                    | `true`                                                                             |
| `existingConfigMap`                           | Configmap override, defining this will cause templates/config.yaml to not generate a configmap                                                                                                                                                                                                                                                                  | ""                                                                                 |
| `extraVolumeMounts`                           | Extra volume mounts for the fluent-bit pod.                                                                                                                                                                                                                                                                                                                     | `[]`                                                                               |
| `extraVolumes`                                | Extra volumes containing additional files required for fluent-bit to work                                                                                                                                                                                                                                                                                       | `[]`                                                                               |
| `resources`                                   | Resource QoS provided to the Pod created by the Deployment                                                                                                                                                                                                                                                                                                      |                                                                                    |
| `podAnnotations`                              | Attach arbitrary non-identifying metadata to objects                                                                                                                                                                                                                                                                                                            | `{}`                                                                               |
| `nodeSelector`                                | Attach arbitrary nodeSelector in PodSpec                                                                                                                                                                                                                                                                                                                        | `{}`                                                                               |
| `tolerations`                                 | The tolerations configuration of the deployment.                                                                                                                                                                                                                                                                                                                | `{}`                                                                               |
| `affinity`                                    | The affinity configuration of the deployment.                                                                                                                                                                                                                                                                                                                   | `{}`                                                                               |
| `tests.enabled`                               | Switch to enable tests on this chart                                                                                                                                                                                                                                                                                                                            | `false`                                                                            |
| `tests.image.repository`                      | Path to the bats Docker image on a specific Docker registry, used for Chart testing.                                                                                                                                                                                                                                                                            | `us.gcr.io/sap-se-hyb-idefix-operations/lms/bats`                                  |
| `tests.image.tag`                             | Version of the bats proxy Docker image .                                                                                                                                                                                                                                                                                                                        | `1.1.0-1`                                                                          |

Specify each parameter using the `--set key=value[,key=value]` argument to `helm install`.

Alternatively, a YAML file that specifies the values for the parameters can be provided while installing the chart. For example,

```console
helm install --name my-release -f values.yaml lms-helm-charts/fluent-bit
```

> **Tip**: You can use the default [values.yaml](values.yaml)
